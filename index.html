<!DOCTYPE html>
<html lang="en">
<head>
    <!-- åŸºæœ¬çš„ãƒ¡ã‚¿æƒ…å ± -->
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>:)</title>
    <!-- å¿…è¦ãªãƒ©ã‚¤ãƒ–ãƒ©ãƒªã¨ãƒ•ã‚©ãƒ³ãƒˆã®èª­ã¿è¾¼ã¿ -->
    <script src="/socket.io/socket.io.js"></script>
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Roboto+Mono:wght@300;400;500&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Quicksand:wght@700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <!-- ãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div class="page-container">
        <div class="container">
            <h1 class="title">
                <span class="flip-text" data-emoji="ğŸ’¬"><span>Speech</span></span>
                to 
                <span class="flip-text" data-emoji="ğŸ“ƒ"><span>Text</span></span>
                <span class="rotate-smile">:)</span>
            </h1>

            <!-- æ–‡å­—èµ·ã“ã—ãƒ†ã‚­ã‚¹ãƒˆã‚’è¡¨ç¤ºã™ã‚‹ã‚¨ãƒªã‚¢ -->
            <div id="transcript" class="transcript-box"></div>

            <!-- ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ«ãƒœã‚¿ãƒ³ -->
            <div class="button-group">
                <button id="micButton" class="fab-button">
                    <span class="material-icons">mic</span>
                </button>
                <button id="resetButton" class="fab-button">
                    <span class="material-icons">refresh</span>
                </button>
                <button id="helpButton" class="fab-button">
                    <span class="material-icons">help_outline</span>
                </button>
            </div>
        </div>
    </div>

    <!-- ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ« -->
    <div class="help-panel">
        <h3>Instructions</h3>
        <ul>
            <li>Click microphone button to start recording</li>
            <li>Click again to stop recording</li>
            <li>Use reset button to clear text</li>
            <li>Make sure to allow microphone access</li>
        </ul>
        <div class="author">Created by HuangHaiya for IBM :)</div>
    </div>

    <script>
        class SpeechRecognitionManager {
            constructor() {
                // WebSocketã®åˆæœŸåŒ–
                this._ws = io();
                this._audioCtx = null;
                this._audioSrc = null;
                this._audioProcessor = null;
                this._isActive = false;
                this._lastUtteranceTime = Date.now();

                // DOMè¦ç´ ã®åˆæœŸåŒ–
                this._elements = {
                    mic: document.getElementById('micButton'),
                    reset: document.getElementById('resetButton'),
                    help: document.getElementById('helpButton'),
                    output: document.getElementById('transcript'),
                    helpPanel: document.querySelector('.help-panel')
                };

                // æ–‡å­—èµ·ã“ã—ã®çŠ¶æ…‹
                this._state = {
                    currentText: '',
                    completedLines: [],
                    helpPanelTimer: null
                };

                this._initEventListeners();
                this._initSocketHandlers();
            }

            _initEventListeners() {
                // ãƒã‚¤ã‚¯ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                this._elements.mic.addEventListener('click', () => this._toggleRecording());
                
                // ãƒªã‚»ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
                this._elements.reset.addEventListener('click', () => this._resetTranscript());

                // ãƒ˜ãƒ«ãƒ—ãƒ‘ãƒãƒ«ã®è¡¨ç¤ºåˆ¶å¾¡
                const handleHelpPanel = (isEnter) => {
                    clearTimeout(this._state.helpPanelTimer);
                    if (isEnter) {
                        this._elements.helpPanel.classList.add('visible');
                    } else {
                        this._state.helpPanelTimer = setTimeout(() => {
                            this._elements.helpPanel.classList.remove('visible');
                        }, 300);
                    }
                };

                this._elements.help.addEventListener('mouseenter', () => handleHelpPanel(true));
                this._elements.help.addEventListener('mouseleave', () => handleHelpPanel(false));
                this._elements.helpPanel.addEventListener('mouseenter', () => handleHelpPanel(true));
                this._elements.helpPanel.addEventListener('mouseleave', () => handleHelpPanel(false));
                
                document.querySelectorAll('.flip-text').forEach(element => {
                    element.addEventListener('click', function() {
                    this.classList.toggle('flipped');
                });
    });
            }

            _initSocketHandlers() {
                // æ–‡å­—èµ·ã“ã—çµæœã®å—ä¿¡
                this._ws.on('transcription', data => {
                    const now = Date.now();
                    const silenceDuration = now - this._lastUtteranceTime;
                    
                    if (data.isFinal) {
                        if (silenceDuration > 800 && this._state.completedLines.length) {
                            this._state.completedLines.push('');
                        }
                        this._state.completedLines.push(data.text);
                        this._state.currentText = '';
                        this._lastUtteranceTime = now;
                    } else {
                        this._state.currentText = data.text;
                    }
                    this._renderTranscript();
                });

                // ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°
                this._ws.on('error', err => {
                    console.error('ã‚µãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼:', err);
                    this._state.completedLines.push(`ã‚¨ãƒ©ãƒ¼: ${err}`);
                    this._renderTranscript();
                });
            }

            async _startRecording() {
                try {
                    // ãƒã‚¤ã‚¯ã®ä½¿ç”¨è¨±å¯ã‚’å–å¾—
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆã®è¨­å®š
                    this._audioCtx = new AudioContext();
                    this._audioSrc = this._audioCtx.createMediaStreamSource(stream);
                    this._audioProcessor = this._audioCtx.createScriptProcessor(1024, 1, 1);
                    
                    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªå‡¦ç†ãƒ‘ã‚¤ãƒ—ãƒ©ã‚¤ãƒ³ã®æ§‹ç¯‰
                    this._audioSrc.connect(this._audioProcessor);
                    this._audioProcessor.connect(this._audioCtx.destination);

                    // ã‚ªãƒ¼ãƒ‡ã‚£ã‚ªãƒ‡ãƒ¼ã‚¿ã®å‡¦ç†
                    this._audioProcessor.onaudioprocess = e => {
                        const rawData = e.inputBuffer.getChannelData(0);
                        const processedData = new Int16Array(rawData.length);
                        
                        // éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å¤‰æ›å‡¦ç†
                        for (let i = 0; i < rawData.length; i++) {
                            processedData[i] = Math.max(-32768, Math.min(32767, Math.floor(rawData[i] * 32768)));
                        }
                        
                        this._ws.emit('audioData', processedData.buffer);
                    };

                    // éŒ²éŸ³é–‹å§‹
                    this._ws.emit('startTranscription');
                    this._isActive = true;
                    this._elements.mic.classList.add('recording');
                    
                    console.log('éŒ²éŸ³ã‚’é–‹å§‹ã—ã¾ã—ãŸ');
                } catch (err) {
                    console.error('ãƒã‚¤ã‚¯ã®æ¥ç¶šã‚¨ãƒ©ãƒ¼:', err);
                    this._elements.output.textContent = `ã‚¨ãƒ©ãƒ¼: ${err.message}`;
                }
            }

            _stopRecording() {
                if (this._audioCtx?.state !== 'closed') {
                    this._audioSrc?.disconnect();
                    this._audioProcessor?.disconnect();
                    this._audioCtx?.close();
                    this._ws.emit('stopTranscription');
                    this._isActive = false;
                    this._elements.mic.classList.remove('recording');
                    console.log('éŒ²éŸ³ã‚’åœæ­¢ã—ã¾ã—ãŸ');
                }
            }

            _toggleRecording() {
                this._isActive ? this._stopRecording() : this._startRecording();
            }

            _resetTranscript() {
                this._state.currentText = '';
                this._state.completedLines = [];
                this._elements.output.innerHTML = '';
                this._lastUtteranceTime = Date.now();
                console.log('æ–‡å­—èµ·ã“ã—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã—ãŸ');
            }

            _renderTranscript() {
                const lines = [
                    ...this._state.completedLines.map(line => `<div class="transcript-line">${line}</div>`),
                    this._state.currentText ? `<div class="transcript-line new">${this._state.currentText}</div>` : ''
                ];
                this._elements.output.innerHTML = lines.join('');
            }
        }

        // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®åˆæœŸåŒ–
        new SpeechRecognitionManager();
    </script>
</body>
</html>